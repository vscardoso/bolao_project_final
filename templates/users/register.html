{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastro | Bolão Online{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth-forms.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <div class="card-unified">
                <!-- Header com logo e título -->
                <div class="text-center mb-4">
                    <div class="register-icon-header">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h1 class="h2 mb-2">Criar sua conta</h1>
                    <p class="text-muted">
                        Junte-se a milhares de apostadores e comece a ganhar!
                    </p>
                </div>

                <!-- Benefícios rápidos -->
                <div class="benefits-quick mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="benefit-quick-item">
                                <i class="fas fa-trophy text-primary"></i>
                                <span>Crie bolões</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="benefit-quick-item">
                                <i class="fas fa-chart-line text-success"></i>
                                <span>Acompanhe rankings</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="benefit-quick-item">
                                <i class="fas fa-medal text-warning"></i>
                                <span>Ganhe prêmios</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alertas e mensagens -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Formulário de registro -->
                <form method="post" novalidate class="needs-validation">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_username" class="form-label">
                                Nome de usuário <span class="text-danger">*</span>
                            </label>
                            {{ form.username }}
                            {% if form.username.errors %}
                                <div class="invalid-feedback d-block">{{ form.username.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Este será seu nome público no site</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">
                                Email <span class="text-danger">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="id_password1" class="form-label">
                            Senha <span class="text-danger">*</span>
                        </label>
                        <div class="password-input-wrapper">
                            {{ form.password1 }}
                            <button type="button" class="password-toggle-btn" data-target="id_password1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="password-strength" class="mt-2">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="password-strength-text text-muted">Força da senha: Muito fraca</small>
                        </div>
                        <div id="password-requirements" class="mt-2">
                            <small class="text-muted d-block mb-2"><i class="fas fa-info-circle me-1"></i> Sua senha deve ter:</small>
                            <div class="password-requirements-items">
                                <div id="req-length" class="password-requirement-item">
                                    <i class="fas fa-circle-xmark text-danger me-2"></i>
                                    <span>Pelo menos 8 caracteres</span>
                                </div>
                                <div id="req-number" class="password-requirement-item">
                                    <i class="fas fa-circle-xmark text-danger me-2"></i>
                                    <span>Não pode ser inteiramente numérico</span>
                                </div>
                                <div id="req-common" class="password-requirement-item">
                                    <i class="fas fa-circle-xmark text-danger me-2"></i>
                                    <span>Não pode ser uma senha comum</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="id_password2" class="form-label">
                            Confirmar senha <span class="text-danger">*</span>
                        </label>
                        <div class="password-input-wrapper">
                            {{ form.password2 }}
                            <button type="button" class="password-toggle-btn" data-target="id_password2">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.password2.errors %}
                            <div class="invalid-feedback d-block">{{ form.password2.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Campos adicionais do formulário -->
                    {% for field in form %}
                        {% if field.name != 'username' and field.name != 'email' and field.name != 'password1' and field.name != 'password2' %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Política de privacidade -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="privacyCheck" required>
                        <label class="form-check-label small" for="privacyCheck">
                            Eu li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Termos de Uso</a>
                            e <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Política de Privacidade</a>
                        </label>
                        <div class="invalid-feedback">
                            Você precisa concordar com os termos para continuar.
                        </div>
                    </div>

                    <div class="d-grid gap-2 mb-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-user-plus me-2"></i>Criar minha conta
                        </button>
                    </div>
                </form>

                <!-- Divisor -->
                <div class="divider">
                    <span class="divider-text">ou registre-se com</span>
                </div>

                <!-- Botões de redes sociais -->
                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <a href="#" class="btn btn-outline-secondary w-100">
                            <i class="fab fa-google me-2"></i>Google
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="#" class="btn btn-outline-secondary w-100">
                            <i class="fab fa-facebook-f me-2"></i>Facebook
                        </a>
                    </div>
                </div>

                <!-- Link para login -->
                <div class="text-center">
                    <p class="text-muted mb-0">
                        Já tem uma conta?
                        <a href="{% url 'login' %}" class="login-link">Entrar</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modais de Termos e Política -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Termos de Uso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Aceitação dos Termos</h6>
                <p>Ao acessar e utilizar o Bolão Online, você concorda em cumprir estes Termos de Uso.</p>

                <h6>2. Regras de Participação</h6>
                <p>Para participar dos bolões, você deve ter idade mínima de 18 anos e seguir todas as regras específicas de cada competição.</p>

                <h6>3. Responsabilidades</h6>
                <p>O Bolão Online não se responsabiliza por apostas perdidas, resultados contestados ou quaisquer disputas entre participantes.</p>

                <h6>4. Alterações dos Termos</h6>
                <p>Reservamos o direito de modificar estes termos a qualquer momento, sendo sua responsabilidade verificar periodicamente por atualizações.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">Política de Privacidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Informações Coletadas</h6>
                <p>Coletamos dados como nome, e-mail e informações de uso para proporcionar uma melhor experiência.</p>

                <h6>2. Uso de Dados</h6>
                <p>Utilizamos seus dados para aprimorar nossos serviços, enviar notificações e personalizar sua experiência.</p>

                <h6>3. Compartilhamento</h6>
                <p>Não compartilhamos suas informações pessoais com terceiros sem seu consentimento expresso.</p>

                <h6>4. Segurança</h6>
                <p>Implementamos medidas de segurança para proteger suas informações contra acesso não autorizado.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validação personalizada
    const form = document.querySelector('form.needs-validation');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    }

    // Password toggle
    document.querySelectorAll('.password-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });

    // Password strength checker
    const passwordInput = document.querySelector('#id_password1');
    const passwordConfirmInput = document.querySelector('#id_password2');
    const passwordStrengthBar = document.querySelector('#password-strength .progress-bar');
    const passwordStrengthText = document.querySelector('.password-strength-text');

    const commonPasswords = ['password', '12345678', 'qwerty', 'admin123', 'welcome', 'senha123'];

    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const username = document.querySelector('#id_username')?.value || '';
            let strengthScore = 0;

            // Check length
            const reqLength = document.querySelector('#req-length i');
            if (password.length >= 8) {
                reqLength.className = 'fas fa-circle-check text-success me-2';
                strengthScore += 25;
            } else {
                reqLength.className = 'fas fa-circle-xmark text-danger me-2';
            }

            // Check not numeric only
            const reqNumber = document.querySelector('#req-number i');
            if (!/^\d+$/.test(password) && password.length > 0) {
                reqNumber.className = 'fas fa-circle-check text-success me-2';
                strengthScore += 25;
            } else {
                reqNumber.className = 'fas fa-circle-xmark text-danger me-2';
            }

            // Check not common
            const reqCommon = document.querySelector('#req-common i');
            if (!commonPasswords.includes(password.toLowerCase()) && password.length > 0) {
                reqCommon.className = 'fas fa-circle-check text-success me-2';
                strengthScore += 25;
            } else {
                reqCommon.className = 'fas fa-circle-xmark text-danger me-2';
            }

            // Bonus points for complexity
            if (password.length > 12) strengthScore += 10;
            if (/[A-Z]/.test(password)) strengthScore += 5;
            if (/[a-z]/.test(password)) strengthScore += 5;
            if (/[0-9]/.test(password)) strengthScore += 5;
            if (/[^A-Za-z0-9]/.test(password)) strengthScore += 10;

            strengthScore = Math.min(strengthScore, 100);

            // Update progress bar
            let strengthColor = 'danger';
            let strengthLabel = 'Muito fraca';

            if (strengthScore >= 80) {
                strengthColor = 'success';
                strengthLabel = 'Forte';
            } else if (strengthScore >= 60) {
                strengthColor = 'warning';
                strengthLabel = 'Média';
            } else if (strengthScore >= 40) {
                strengthColor = 'warning';
                strengthLabel = 'Regular';
            } else if (strengthScore >= 20) {
                strengthColor = 'danger';
                strengthLabel = 'Fraca';
            }

            passwordStrengthBar.className = `progress-bar bg-${strengthColor}`;
            passwordStrengthBar.style.width = `${strengthScore}%`;
            passwordStrengthText.textContent = `Força da senha: ${strengthLabel}`;
        });
    }

    // Verify passwords match
    if (passwordConfirmInput && passwordInput) {
        passwordConfirmInput.addEventListener('input', function() {
            if (this.value === passwordInput.value) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            }
        });
    }
});
</script>
{% endblock %}
